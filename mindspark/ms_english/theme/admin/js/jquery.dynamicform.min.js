(function(b){b.fn.dynamicForm=function(L,R,A){var K=b(this),P,a,O,Q="input, checkbox, select, textarea",G=[],H={duration:1000,normalizeFullForm:true,isSubDynamicForm:false},z=[],N;if(A.internalSubDynamicForm){P=b(A.internalContainer).find(R);a=b(A.internalContainer).find(L)}else{P=b(R);a=b(L)}A=b.extend(H,A);N=A.formPrefix||K.selector.replace(/\W/g,"");function E(e){var c,d;c=O.cloneWithAttribut(true);if(typeof A.afterClone==="function"){d=A.afterClone(c)}if(d||typeof d=="undefined"){c.insertAfter(G[G.length-1]||K)}c.getSource=function(){return K};if(c.attr("id")){c.attr("id",c.attr("id")+G.length)}if(c.effect&&A.createColor&&!e){c.effect("highlight",{color:A.createColor},A.duration)}return c}function J(c){b(z).each(function(){var e=this.getPlusSelector(),g=this.getMinusSelector(),f=this.getOptions(),d=this.selector;c.find(this.selector).each(function(){f=b.extend({internalSubDynamicForm:true,internalContainer:c,isInAClone:true,outerCloneIndex:G.length,selector:d},f);b(this).dynamicForm(e,g,f)})})}function C(e,d){var f,c=G[G.length-1]||K;e.preventDefault();c.find(R).show();c.find(L).hide();if(G.length===0){K.find(R).hide()}f=E(d);a=f.find(L);P=f.find(R);P.get(0).removableClone=f;P.click(F);if(A.limit&&(A.limit-2)>G.length){a.show();P.show()}else{a.hide();P.show()}G.push(f);x(f,G.length);J(f)}function I(d,c){var e;d.preventDefault();if(G.length===0){P.show()}e=E(c);if(A.limit&&(A.limit-3)<G.length){a.hide()}G.push(e);x(e,G.length);J(e)}function F(c){c.preventDefault();if(this.removableClone.effect&&A.removeColor){that=this;this.removableClone.effect("highlight",{color:A.removeColor},A.duration,function(){that.removableClone.remove()})}else{this.removableClone.remove()}G.splice(b.inArray(this.removableClone,G),1);if(G.length===0){K.find(L).show()}else{G[G.length-1].find(L).show()}}function B(c){c.preventDefault();var d=G.pop();if(G.length>=0){if(d.effect&&A.removeColor){that=this;d.effect("highlight",{color:A.removeColor,mode:"hide"},A.duration,function(){d.remove()})}else{d.remove()}}if(G.length===0){P.hide()}a.show()}function M(e,c,d){e.find(Q).each(function(){var j=b(this),g=j.attr("name"),h=j.attr("origname"),f=j.attr("id"),i=j.attr("origid");if(!g){j.attr("name","field"+d+"[]")}if(h){j.attr("name",h)}else{j.attr("origname",g);j.attr("name",g)}if(f){j.attr("origid",f);b("label[for='"+f+"']").each(function(){b(this).attr("origfor",f);b(this).attr("for",f+d)});j.attr("id",f+d)}})}function x(f,e){var d,c=/(.+\[[^\[\]]+\]\[)(\d+)(\]\[[^\[\]]+\])$/;f.find(Q).each(function(){var i=b(this),h=i.attr("name"),k=i.attr("origname"),g=i.attr("id"),j=g.slice(0,-1)+e,l=c.exec(h);if(g){i.attr("origid",g);f.find("label[for='"+g+"']").each(function(){b(this).attr("for",j)});i.attr("id",j)}})}function D(e,g,d){var c,f=/(.+)\[([^\[\]]+)\]$/;e.find(Q).each(function(){var k=b(this),i=k.attr("name"),l=k.attr("id"),j=l+d,h=f.exec(i);k.attr("name",h[1]+"["+g+"]["+d+"]["+h[2]+"]");if(l){k.attr("origid",l);e.find("label[for='"+l+"']").each(function(){b(this).attr("for",j)});k.attr("id",j)}})}K.each(function(){b.extend(this,{addSubDynamicForm:function(c){z.push(c)},getFormPrefix:function(){return N},getSource:function(){return K}})});var y=true;b(this).parentsUntil("body").each(function(){if(b.isFunction(this.addSubDynamicForm)&&!A.isSubDynamicForm){y=false;A.isSubDynamicForm=true;var c=b.extend({internalSubDynamicForm:true,internalContainer:this},A);this.addSubDynamicForm(K);N=this.getFormPrefix()+"[0]["+N+"]";return false}});if(y&&!A.isInAClone){N=N+"["+N+"]"}if(!A.isInAClone){M(K,N,0)}else{N=N||A.selector.replace(/\W/g,"");D(K,N,0)}if(y&&A.normalizeFullForm&&!A.isInAClone){b(this).parentsUntil("form").each(function(){var c=b(this).parent().get(0);b(c).find(Q).filter("[type!=submit]").each(function(){var f=b(this),e=f.attr("name"),h=f.attr("origname"),g=f.attr("id"),d=f.attr("origid");if(!h){if(!e){}f.attr("origname",e);f.attr("name",N+"["+e+"]")}})})}isPlusDescendentOfTemplate=K.find("*").filter(function(){return this==a.get(0)});isPlusDescendentOfTemplate=isPlusDescendentOfTemplate.length>0?true:false;P.hide();if(isPlusDescendentOfTemplate){a.click(C)}else{a.click(I);P.click(B)}b.extend(K,{getPlus:function(){return a},getPlusSelector:function(){return L},getMinus:function(){return P},getMinusSelector:function(){return R},getOptions:function(){return A},getClones:function(){var c=[K];return c.concat(G)},getSource:function(){return K},inject:function(c){function d(g,h){var f=this;if(g>0){f.getSource().getPlus().trigger("click",["disableEffect"])}var e=f.get(0).getSource().getClones()[g];b.each(h,function(j,k){if(b.isArray(k)){f=e.find("#"+j);if(typeof f.get(0).getSource==="function"){b.each(k,b.proxy(d,f.get(0).getSource()))}}else{var i=f.getSource().getClones()[g].find("[origname='"+j+"']");if(i){if(i.get(0).tagName.toLowerCase()=="input"){if(i.attr("type")=="radio"){i.filter("[value='"+k+"']").attr("checked","checked")}else{if(i.attr("type")=="checkbox"){i.attr("checked","checked")}else{i.attr("value",k)}}}else{if(i.get(0).tagName.toLowerCase()=="textarea"){i.text(k)}else{if(i.get(0).tagName.toLowerCase()=="select"){b(i.get(0)).find("option").each(function(){if(b(this).text()==k||b(this).attr("value")==k){b(this).attr("selected","selected")}})}}}}}})}b.each(c,b.proxy(d,K))}});O=K.cloneWithAttribut(true);if(A.data){K.inject(A.data)}return K};jQuery.fn.cloneWithAttribut=function(a){if(jQuery.support.noCloneEvent){return b(this).clone(a)}else{b(this).find("*").each(function(){b(this).data("name",b(this).attr("name"))});var d=b(this).clone(a);d.find("*").each(function(){b(this).attr("name",b(this).data("name"))});return d}}})(jQuery);