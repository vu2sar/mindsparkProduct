(function(a){a.fn.dynamicForm=function(h,b,s){var i=a(this),d,w,e,c="input, checkbox, select, textarea",m=[],l={duration:1000,normalizeFullForm:true,isSubDynamicForm:false},t=[],f;if(s.internalSubDynamicForm){d=a(s.internalContainer).find(b);w=a(s.internalContainer).find(h);}else{d=a(b);w=a(h);}s=a.extend(l,s);f=s.formPrefix||i.selector.replace(/\W/g,"");function o(y){var x,z;x=e.cloneWithAttribut(true);if(typeof s.afterClone==="function"){z=s.afterClone(x);}if(z||typeof z=="undefined"){x.insertAfter(m[m.length-1]||i);}x.getSource=function(){return i;};if(x.attr("id")){x.attr("id",x.attr("id")+m.length);}if(x.effect&&s.createColor&&!y){x.effect("highlight",{color:s.createColor},s.duration);}return x;}function j(x){a(t).each(function(){var z=this.getPlusSelector(),y=this.getMinusSelector(),B=this.getOptions(),A=this.selector;x.find(this.selector).each(function(){B=a.extend({internalSubDynamicForm:true,internalContainer:x,isInAClone:true,outerCloneIndex:m.length,selector:A},B);a(this).dynamicForm(z,y,B);});});}function q(z,x){var y,A=m[m.length-1]||i;z.preventDefault();A.find(b).show();A.find(h).hide();if(m.length===0){i.find(b).hide();}y=o(x);w=y.find(h);d=y.find(b);d.get(0).removableClone=y;d.click(n);if(s.limit&&(s.limit-2)>m.length){w.show();d.show();}else{w.hide();d.show();}m.push(y);v(y,m.length);j(y);}function k(z,x){var y;z.preventDefault();if(m.length===0){d.show();}y=o(x);if(s.limit&&(s.limit-3)<m.length){w.hide();}m.push(y);v(y,m.length);j(y);}function n(x){x.preventDefault();if(this.removableClone.effect&&s.removeColor){that=this;this.removableClone.effect("highlight",{color:s.removeColor},s.duration,function(){that.removableClone.remove();});}else{this.removableClone.remove();}m.splice(a.inArray(this.removableClone,m),1);if(m.length===0){i.find(h).show();}else{m[m.length-1].find(h).show();}}function r(x){x.preventDefault();var y=m.pop();if(m.length>=0){if(y.effect&&s.removeColor){that=this;y.effect("highlight",{color:s.removeColor,mode:"hide"},s.duration,function(){y.remove();});}else{y.remove();}}if(m.length===0){d.hide();}w.show();}function g(y,x,z){y.find(c).each(function(){var B=a(this),E=B.attr("name"),D=B.attr("origname"),A=B.attr("id"),C=B.attr("origid");if(!E){B.attr("name","field"+z+"[]");}if(D){B.attr("name",D);}else{B.attr("origname",E);B.attr("name",E);}if(A){B.attr("origid",A);a("label[for='"+A+"']").each(function(){a(this).attr("origfor",A);a(this).attr("for",A+z);});B.attr("id",A+z);}});}function v(y,z){var A,x=/(.+\[[^\[\]]+\]\[)(\d+)(\]\[[^\[\]]+\])$/;y.find(c).each(function(){var E=a(this),F=E.attr("name"),C=E.attr("origname"),G=E.attr("id"),D=G.slice(0,-1)+z,B=x.exec(F);if(G){E.attr("origid",G);y.find("label[for='"+G+"']").each(function(){a(this).attr("for",D);});E.attr("id",D);}});}function p(z,B,A){var x,y=/(.+)\[([^\[\]]+)\]$/;z.find(c).each(function(){var D=a(this),F=D.attr("name"),C=D.attr("id"),E=C+A,G=y.exec(F);D.attr("name",G[1]+"["+B+"]["+A+"]["+G[2]+"]");if(C){D.attr("origid",C);z.find("label[for='"+C+"']").each(function(){a(this).attr("for",E);});D.attr("id",E);}});}i.each(function(){a.extend(this,{addSubDynamicForm:function(x){t.push(x);},getFormPrefix:function(){return f;},getSource:function(){return i;}});});var u=true;a(this).parentsUntil("body").each(function(){if(a.isFunction(this.addSubDynamicForm)&&!s.isSubDynamicForm){u=false;s.isSubDynamicForm=true;var x=a.extend({internalSubDynamicForm:true,internalContainer:this},s);this.addSubDynamicForm(i);f=this.getFormPrefix()+"[0]["+f+"]";return false;}});if(u&&!s.isInAClone){f=f+"["+f+"]";}if(!s.isInAClone){g(i,f,0);}else{f=f||s.selector.replace(/\W/g,"");p(i,f,0);}if(u&&s.normalizeFullForm&&!s.isInAClone){a(this).parentsUntil("form").each(function(){var x=a(this).parent().get(0);a(x).find(c).filter("[type!=submit]").each(function(){var z=a(this),C=z.attr("name"),B=z.attr("origname"),y=z.attr("id"),A=z.attr("origid");if(!B){if(!C){}z.attr("origname",C);z.attr("name",f+"["+C+"]");}});});}isPlusDescendentOfTemplate=i.find("*").filter(function(){return this==w.get(0);});isPlusDescendentOfTemplate=isPlusDescendentOfTemplate.length>0?true:false;d.hide();if(isPlusDescendentOfTemplate){w.click(q);}else{w.click(k);d.click(r);}a.extend(i,{getPlus:function(){return w;},getPlusSelector:function(){return h;},getMinus:function(){return d;},getMinusSelector:function(){return b;},getOptions:function(){return s;},getClones:function(){var x=[i];return x.concat(m);},getSource:function(){return i;},inject:function(x){function y(C,B){var z=this;if(C>0){z.getSource().getPlus().trigger("click",["disableEffect"]);}var A=z.get(0).getSource().getClones()[C];a.each(B,function(E,D){if(a.isArray(D)){z=A.find("#"+E);if(typeof z.get(0).getSource==="function"){a.each(D,a.proxy(y,z.get(0).getSource()));}}else{var F=z.getSource().getClones()[C].find("[origname='"+E+"']");if(F){if(F.get(0).tagName.toLowerCase()=="input"){if(F.attr("type")=="radio"){F.filter("[value='"+D+"']").attr("checked","checked");}else{if(F.attr("type")=="checkbox"){F.attr("checked","checked");}else{F.attr("value",D);}}}else{if(F.get(0).tagName.toLowerCase()=="textarea"){F.text(D);}else{if(F.get(0).tagName.toLowerCase()=="select"){a(F.get(0)).find("option").each(function(){if(a(this).text()==D||a(this).attr("value")==D){a(this).attr("selected","selected");}});}}}}}});}a.each(x,a.proxy(y,i));}});e=i.cloneWithAttribut(true);if(s.data){i.inject(s.data);}return i;};jQuery.fn.cloneWithAttribut=function(b){if(jQuery.support.noCloneEvent){return a(this).clone(b);}else{a(this).find("*").each(function(){a(this).data("name",a(this).attr("name"));});var c=a(this).clone(b);c.find("*").each(function(){a(this).attr("name",a(this).data("name"));});return c;}};})(jQuery);