//essayDashboard.js
var fbJSON = {"essayID":"56","wordLimit":"0","writerID":"92","topicID":"0",
"title":"Experience of my  Exams",
"essay":"Exams are test papers which check your knowledge about that particular subject. They are test papers which decide your future and career. These exams are there until you graduate . There are two types of exams comparitive and those just to check your knowledge. Comparaitive exams are those in which you see your marks and that decides in which position your job will be. There are two exams in our school Half Yearly and Annual Exams. Half Yearly&nbsp;are in mid- term between September and October. Annual exams are more important nd they occur in the end of our school term.&nbsp;Both are equally important as I believe.<div>Our Half Yearly exams were starting from 16 of September and we had seven papers in all the sequence of our paper was as per our UTs which was Geography, Gujarati, Maths, History/Civics, Science, Hindi, English. UT is unit test which is held every week.&nbsp;My favourite subject is Maths and I was worried about that subject only as I got less marks in my maths UT. Our every exam except languages consisted of 80 marks and our languages consisted of 60 marks , our 60 marks paper were Hindi and English.</div><div>All my exams went with ease and &nbsp;think I will get 70 up marks in all subjects.</div>",
"status":"2",
"startTime":"2013-09-22 12:18:47",
"submittedOn":"2013-10-17 22:18:55",
"timeTaken":"1489",
"lastModified":"2013-10-20 12:55:11",
"anyfb":true,
"report":{"f1":{"0":"Good attempt. Focus more on sentence construction and length of sentences. Use commas and full stops whenever the sentence gets too long, it helps to organise the idea that you are trying to convey.<div><br></div><div>Also focus on the difference between writing and speaking. Some phrases are acceptable in speech but not in writing.</div><div><br></div><div>Keep it up!</div>","1":"2013-10-19 12:52:41","2":"7","3":"Comment for [These exams are there]|*|138~159|*|You can replace this with \\\"One must keep giving exams until one graduates.\\\" Passive voice is better used in such statements which are applicable to everyone.{|~|}Comment for [ ]|*|209~210|*|Add comma{|~|}Comment for [comparitive]|*|210~221|*|Do you mean competitive?{|~|}Comment for [in]|*|542~544|*|\\'at\\' the end of a term.{|~|}Comment for [Both are equally important as I believe.]|*|573~613|*|Consider rephrasing - \\\"I believe that both are equally important\\\".{|~|}Comment for [ ]|*|701~702|*|Full stop missing.{|~|}Comment for [only]|*|935~939|*|No need to add \\'only\\' at the end of a phrase.{|~|}Comment for [Our ]|*|976~980|*|Not required to use \\'our\\'.{|~|}Comment for [ languages ]|*|1037~1048|*|\\\"our \\'language exams\\'...\\\"{|~|}Comment for [70 up]|*|1165~1170|*|\\'70 up\\' is not proper word usage. You can say, \\\"I will get upwards of 70 marks\\\" or \\\"more than 70 marks\\\".{|~|}Comment for [Comparaitive]|*|262~274|*|Misspelt.","feedback":"Good attempt. Focus more on sentence construction and length of sentences. Use commas and full stops whenever the sentence gets too long, it helps to organise the idea that you are trying to convey.<div><br></div><div>Also focus on the difference between writing and speaking. Some phrases are acceptable in speech but not in writing.</div><div><br></div><div>Keep it up!</div>","submittedOn":"2013-10-19 12:52:41","score":"7","selectFeedback":"Comment for [These exams are there]|*|138~159|*|You can replace this with \\\"One must keep giving exams until one graduates.\\\" Passive voice is better used in such statements which are applicable to everyone.{|~|}Comment for [ ]|*|209~210|*|Add comma{|~|}Comment for [comparitive]|*|210~221|*|Do you mean competitive?{|~|}Comment for [in]|*|542~544|*|\\'at\\' the end of a term.{|~|}Comment for [Both are equally important as I believe.]|*|573~613|*|Consider rephrasing - \\\"I believe that both are equally important\\\".{|~|}Comment for [ ]|*|701~702|*|Full stop missing.{|~|}Comment for [only]|*|935~939|*|No need to add \\'only\\' at the end of a phrase.{|~|}Comment for [Our ]|*|976~980|*|Not required to use \\'our\\'.{|~|}Comment for [ languages ]|*|1037~1048|*|\\\"our \\'language exams\\'...\\\"{|~|}Comment for [70 up]|*|1165~1170|*|\\'70 up\\' is not proper word usage. You can say, \\\"I will get upwards of 70 marks\\\" or \\\"more than 70 marks\\\".{|~|}Comment for [Comparaitive]|*|262~274|*|Misspelt."},"f2":{"0":"Work on phrasing sentences and punctuate correctly. Good attempt, but you could speak more about a specific examination like your Maths paper. You could write about how you felt before the paper, what was your reaction when you saw the paper itself, and how happy/excited were you on finishing it.","1":"2013-10-20 12:55:11","2":"6","3":"Comment for [that particular]|*|55~70|*|a particular{|~|}Comment for [ exams comparitive]|*|203~221|*|exams, comparative{|~|}Comment for [Comparaitive]|*|262~274|*|Comparative{|~|}Comment for [school Half Yearly]|*|399~417|*|school - Half yearly{|~|}Comment for [ are in mid- term between September and October]|*|447~494|*|are between September and October{|~|}Comment for [ nd]|*|527~530|*|and{|~|}Comment for [important as I believe]|*|590~612|*|important, I believe{|~|}Comment for [ 16 of September]|*|654~670|*|the 16th of September{|~|}Comment for [Our every exam ]|*|976~991|*|Every exam of ours{|~|}Comment for [ papers in all the ]|*|687~706|*|papers in all, and the{|~|}Comment for [ paper]|*|721~727|*|papers{|~|}Comment for [marks , our 60 marks paper were Hindi and English]|*|1064~1113|*|marks. Hindi and English papers were worth 60 marks each{|~|}Comment for [ get 70 up]|*|1160~1170|*|get above 70","feedback":"Work on phrasing sentences and punctuate correctly. Good attempt, but you could speak more about a specific examination like your Maths paper. You could write about how you felt before the paper, what was your reaction when you saw the paper itself, and how happy/excited were you on finishing it.","submittedOn":"2013-10-20 12:55:11","score":"6","selectFeedback":"Comment for [that particular]|*|55~70|*|a particular{|~|}Comment for [ exams comparitive]|*|203~221|*|exams, comparative{|~|}Comment for [Comparaitive]|*|262~274|*|Comparative{|~|}Comment for [school Half Yearly]|*|399~417|*|school - Half yearly{|~|}Comment for [ are in mid- term between September and October]|*|447~494|*|are between September and October{|~|}Comment for [ nd]|*|527~530|*|and{|~|}Comment for [important as I believe]|*|590~612|*|important, I believe{|~|}Comment for [ 16 of September]|*|654~670|*|the 16th of September{|~|}Comment for [Our every exam ]|*|976~991|*|Every exam of ours{|~|}Comment for [ papers in all the ]|*|687~706|*|papers in all, and the{|~|}Comment for [ paper]|*|721~727|*|papers{|~|}Comment for [marks , our 60 marks paper were Hindi and English]|*|1064~1113|*|marks. Hindi and English papers were worth 60 marks each{|~|}Comment for [ get 70 up]|*|1160~1170|*|get above 70"}}};

var essayOpen = false;
var timer = null;
var secs = 0;
var anyFB = false;
var opts = {};
var timeOutVar = null;
var rubricHTML = '<div style="text-align:left;"><div id="showRub">Show rubric</div><div id="hideRub">Hide rubric</div></div><p align="center"><span style="font:1.5em sans-serif">Rubric for evaluation</span><br><span style="font-size:0.9em;">(Place cursor over a cell for description)</span> </p><table border="1" cellspacing="0" width="100%"><tr><th>Category</th><th>5</th><th>4</th><th>3</th><th>2</th><th>1</th><th>N.A.</th></tr><tr min="10"><td><strong>Punctuation, Tense &amp; Spelling</strong></td><td title="No spelling/punctuation errors. Skilful and subtle transition between tenses where necessary." class="radioCell"><input type="radio" value="5" name="c1" id="r15"/><label for="r15"></label></td><td title="Few spelling errors in advanced words. Good knowledge of tense. Showcases successful switch in tense." class="radioCell"><input type="radio" value="4" name="c1" id="r14"/><label for="r14"></label></td><td title="No spelling errors in basic words. Lacking knowledge of advanced punctuation. Several spelling errors in advanced words, satisfactory knowledge of basic tense." class="radioCell"><input type="radio" value="3" name="c1" id="r13"/><label for="r13"></label></td><td title="Poor punctuation, few spelling errors in basic words. Some knowledge of tense." class="radioCell"><input type="radio" value="2" name="c1" id="r12"/><label for="r12"></label></td><td title="Poor use of punctuation, spelling errors in basic words. No knowledge of tense." class="radioCell"><input type="radio" value="1" name="c1" id="r11"/><label for="r11"></label></td><td title="Not applicable" class="radioCell"><input type="radio" value="0" name="c1" id="r10"/><label for="r10"></label></td></tr><tr min="10"><td><strong>Word choice/Vocabulary</strong></td><td title="Correct use of complex words and only where necessary" class="radioCell"><input type="radio" value="5" name="c2" id="r25"/><label for="r25"></label></td><td title="Correct yet unnecessary/repetitive use of complex words" class="radioCell"><input type="radio" value="4" name="c2" id="r24"/><label for="r24"></label></td><td title="Incorrect and repetitive use of advanced/complex words" class="radioCell"><input type="radio" value="3" name="c2" id="r23"/><label for="r23"></label></td><td title="Correct but repetitive use of basic words, no knowledge of advanced words" class="radioCell"><input type="radio" value="2" name="c2" id="r22"/><label for="r22"></label></td><td title="Incorrect and repetitive use of basic words" class="radioCell"><input type="radio" value="1" name="c2" id="r21"/><label for="r21"></label></td><td title="Not applicable" class="radioCell"><input type="radio" value="0" name="c2" id="r20"/><label for="r20"></label></td></tr><tr min="10"><td><strong>Syntax &amp; Semantics</strong></td><td title="Coherent and complete sentences, employing correct use of parts of speech. Sentences are consistently semantically sound." class="radioCell"><input type="radio" value="5" name="c3" id="r35"/><label for="r35"></label></td><td title="Coherent and complete sentences, employing correct use of parts of speech. Sentences are syntactically sound but extremely non-contextual." class="radioCell"><input type="radio" value="4" name="c3" id="r34"/><label for="r34"></label></td><td title="Coherent sentences but employing incorrect use of parts of speech at times. Sentences are semantically unsound, lack meaning." class="radioCell"><input type="radio" value="3" name="c3" id="r33"/><label for="r33"></label></td><td title="Somewhat coherent yet incomplete sentences (lacking parts of speech where necessary)" class="radioCell"><input type="radio" value="2" name="c3" id="r32"/><label for="r32"></label></td><td title="Poor sentence construction. Incomplete and incoherent sentences." class="radioCell"><input type="radio" value="1" name="c3" id="r31"/><label for="r31"></label></td><td title="Not applicable." class="radioCell"><input type="radio" value="0" name="c3" id="r30"/><label for="r30"></label></td></tr><tr min="6"><td><strong>Organisation/Flow</strong></td><td title="Additional subdivision of intro, body and conclusion to avoid repetition of content." class="radioCell"><input type="radio" value="5" name="c4" id="r45"/><label for="r45"></label></td><td title="Clear demarcation between intro, body and conclusion, with some restatement/repetition." class="radioCell"><input type="radio" value="4" name="c4" id="r44"/><label for="r44"></label></td><td title="Structurally coherent, but no clear demarcation between introduction, body and conclusion." class="radioCell"><input type="radio" value="3" name="c4" id="r43"/><label for="r43"></label></td><td title="The flow of essay is somewhat coherent; Gaps/jumps in content flow at times." class="radioCell"><input type="radio" value="2" name="c4" id="r42"/><label for="r42"></label></td><td title="Incomprehensible; structure of essay is not logical." class="radioCell"><input type="radio" value="1" name="c4" id="r41"/><label for="r41"></label></td><td title="Not applicable." class="radioCell"><input type="radio" value="0" name="c4" id="r40"/><label for="r40"></label></td></tr><tr min="4"><td><strong>Narrative Style/Technique</strong></td><td title="Very engaging; insightfully narrative and vividly descriptive. Usage of advanced techniques like meta-fiction." class="radioCell"><input type="radio" value="5" name="c5" id="r55"/><label for="r55"></label></td><td title="Very engaging; Narrative and also vividly descriptive. Usage of uncommon styles (such as those having multiple voices/perspectives)." class="radioCell"><input type="radio" value="4" name="c5" id="r54"/><label for="r54"></label></td><td title="Engaging; Narrative rather than descriptive. Usage of creative writing styles like prose." class="radioCell"><input type="radio" value="3" name="c5" id="r53"/><label for="r53"></label></td><td title="Descriptive but not very engaging; use of context limited." class="radioCell"><input type="radio" value="2" name="c5" id="r52"/><label for="r52"></label></td><td title="Very basic, dull, e.g. in the format of plain information dissemination." class="radioCell"><input type="radio" value="1" name="c5" id="r51"/><label for="r51"></label></td><td title="Not applicable." class="radioCell"><input type="radio" value="0" name="c5" id="r50"/><label for="r50"></label></td></tr><tr min="2"><td><strong>Knowledge on subject</strong></td><td title="Very strong knowledge base: Ability to tie up main subject matter to other subjects logically and successfully." class="radioCell"><input type="radio" value="5" name="c6" id="r65"/><label for="r65"></label></td><td title="Strong grasp of subject matter; does not indulge in exaggeration / vagueness." class="radioCell"><input type="radio" value="4" name="c6" id="r64"/><label for="r64"></label></td><td title="Decent grasp of subject matter; somewhat superfluous in content." class="radioCell"><input type="radio" value="3" name="c6" id="r63"/><label for="r63"></label></td><td title="Lacks in-depth knowledge; bears several misconceptions and is vague." class="radioCell"><input type="radio" value="2" name="c6" id="r62"/><label for="r62"></label></td><td title="Completely lacking in knowledge of subject matter; no details." class="radioCell"><input type="radio" value="1" name="c6" id="r61"/><label for="r61"></label></td><td title="Not applicable." class="radioCell"><input type="radio" value="0" name="c6" id="r60"/><label for="r60"></label></td></tr><tr min="2"><td><strong>Conciseness</strong></td><td title="Very crisp and concise, while explicating nearly all points." class="radioCell"><input type="radio" value="5" name="c7" id="r75"/><label for="r75"></label></td><td title="Concise, yet expressing few points on a topic." class="radioCell"><input type="radio" value="4" name="c7" id="r74"/><label for="r74"></label></td><td title="Short, but a bit tautological." class="radioCell"><input type="radio" value="3" name="c7" id="r73"/><label for="r73"></label></td><td title="Moderately long and very tautological." class="radioCell"><input type="radio" value="2" name="c7" id="r72"/><label for="r72"></label></td><td title="Long-winded and pointless." class="radioCell"><input type="radio" value="1" name="c7" id="r71"/><label for="r71"></label></td><td title="Not applicable." class="radioCell"><input type="radio" value="0" name="c7" id="r70"/><label for="r70"></label></td></tr></table><br><div style="font-size:1.1em;">Suggested score: <span id="sugScore">-</span>/10</div><script></script>';
var rubricVals = [-1, -1, -1, -1, -1, -1, -1];
var range;

$(document).ready(function() {
    $(document).delegate('.comment', 'mouseover', function() {
        $('.hiliteOn').removeClass('hiliteOn').addClass('hilite');
        var cE = $(this).find('.comM').find('.comT');
        if (cE.length == 0) {
            var l = $(this).attr('label').split('~');
            var a = l[0],
                b = l[1];
            $('.hilite[name="' + a + '~' + b + '"] *').addClass('hiliteOn').removeClass('hilite');
            $('.hilite[name="' + a + '~' + b + '"]').addClass('hiliteOn').removeClass('hilite');
            selStartOffset = a;
            selEndOffset = b;
        }
    });
    
    $(document).delegate('.comment', 'mouseout', function() {
        $('.hiliteOn').removeClass('hiliteOn').addClass('hilite');
    });
    
    $(document).delegate('.comment', 'click', function() {
        $('.hiliteOn').removeClass('hiliteOn').addClass('hilite');
        var cE = $(this).find('.comM').find('.comT');
        if (cE.length == 0) {
            var l = $(this).attr('label').split('~');
            var a = l[0],
                b = l[1];
            $('.hilite[name="' + a + '~' + b + '"] *').addClass('hiliteOn').removeClass('hilite');
            $('.hilite[name="' + a + '~' + b + '"]').addClass('hiliteOn').removeClass('hilite');
            $('.hiliteOn')[0].scrollIntoView(true);
            selStartOffset = a;
            selEndOffset = b;
        }
    });

    $(".modal").show();
    mode = 2;
   
    getUrlParameters();
   
    //lame interval to see if rangy bro has loaded. Once loaded do that ajax magic.
     var lameInterval = setInterval(function(){
            if(rangy.getSelection){
            if(parameters['curObj'] == "reviewedEssays" || parameters['curObj'] == "essaysToReview"){
                var url = parent.Helpers.constants['CONTROLLER_PATH'] + "essayAllotment/getEssay/" + parameters['essayId'] ;
                var callBack = evaluateEssayCallback;
            }
            else{
                var url = parent.Helpers.constants['CONTROLLER_PATH'] + "home/fetchEssayFeedback/" + parameters['essayId'] +"/"+parameters['ewsdetailID'] ;
                var callBack = gradedEssayCallback
            }
                
            var request = $.ajax({
                dataType: "JSON",
               //url: parent.Helpers.constants['CONTROLLER_PATH'] + "home/fetchEssayFeedback/" + parameters['userId'] + "/" + parameters['essayId']
               url: "../../../" + url,
                // url: '../../../' + "home/fetchEssayFeedback/" + parameters['userId'] + "/" + parameters['essayId']
                async:false
            });
            request.done(function(data){
                window.parent.Helpers.ajax_response( callBack, data, [parameters['mode']]);
            });
            request.error(function(){
                 $('.modal').html('<div class="centerCenter">Your feedback is not ready yet.</div>');
            });
            
            clearInterval(lameInterval);
        }        
    }, 100);
    
    $('.modal').delegate('#showRub', "mouseup", function() {
            $("#rubricBox").animate({
                right: '0px'
            });
            $('#showRub').hide();
        });
        $('.modal').delegate('#hideRub', "mouseup", function() {
            $("#rubricBox").animate({
                right: '-450px'
            });
            $('#showRub').show();
        });

       function getelemID(nm) {
            return (nm.charAt(1) * 1) - 1;
        }

       $("body").delegate(".radioCell :radio", "change", (function() {
            var cRB = $(".radioCell :radio:checked"),
                sc = 0,
                distSc = 0,
                dNum = 0;
            for (var i = 0; i < cRB.length; i++) rubricVals[getelemID(cRB.eq(i).attr("name"))] = cRB.eq(i).val() * 1;
            for (var i = 0; i < 7; i++) {
                distSc += (rubricVals[i] == 0) ? $("#rubricBox tr").eq(i + 1).attr("min") * 1 + 8 : 0;
                dNum += (rubricVals[i] == 0) ? 1 : 0;
            }
            distSc = (dNum == 7) ? 0 : (distSc / (7 - dNum));
            for (var i = 0; i < 7; i++) sc += (rubricVals[i] <= 0) ? 0 : (rubricVals[i] - 1) * (2 + distSc / 4) + ($("#rubricBox tr").eq(i + 1).attr("min") * 1);
            sc = Math.round(sc);
            $("#sugScore").html(sc / 10);
            $("#essayScore").val(sc / 10);
        }));


        $('#newEssaybtn').click(function() {
            if (!essayOpen) {
                essayOpen = true;
                showTopicList();
            }
        });

        //if ($('#userStatus').val()=="0" && $('#userType').val()=="2") showTopicList();
        //else 
        //updateLists();
    
    
    $('#addCommentbtn').click(function() {
       getCursor();
        //$('#essayBody').elrte(opts);
        $('#essaySpecificFB').find('.comT').each(function(index) {
            $(this).parent().html($(this).val());
        });
        //$('#essayBody').elrte('val',$('#essayBody').html());
        setHiliteN(1, '',0);
        hideInlineCommentBtn();
        //$('#essayBody').html($('#essayBody').elrte('val'));
        //$('#essayBody').elrte('close');$('#essayBody')[0].style.display='block';
        var lb = $('#essaySpecificFB>.comment').get(-1).getAttribute('label');
        console.log($('#essayBody').html());
        var txt = $('#essayBody').html().replace(/style="background-color:#ff0000"/g, 'class="hilite hiliteOn" name="' + lb + '"');
        $('#essayBody').html(txt);
        $('#essayBody').css({
            'width': '400px',
            'float': 'left'
        });
        $('#essayBody').css({
            'width': '420px',
            'float': 'left'
        });
        $('#essaySpecificFB>.comment').get(-1).scrollIntoView(false);
        $($('#essaySpecificFB>.comment').get(-1)).find('.comT').focus();
    });
    
    $(document).delegate('.comSbtn', 'click', function() {
        $(this).css({
            display: 'none'
        });
        $(this).parent().find('.comEbtn').css({
            display: 'block'
        });
        $(this).parent().find('.comM').attr('contentEditable', 'false');
        $(this).parent().find('.comM').html($(this).parent().find('.comM').find('.comT').val());
        $(this).parent().find('.comM').attr('style', "");
        saveFeedback(-1);
    });
    $(document).delegate('.comEbtn', 'click', function() {
        $(this).css({
            display: 'none'
        });
        $(this).parent().find('.comSbtn').css({
            display: 'block'
        });
        $(this).parent().find('.comM').attr('contentEditable', 'false');
        $(this).parent().find('.comM').html('<textarea class="comT">' + $(this).parent().find('.comM').html() + '</textarea>');
        $(this).parent().find('.comM').attr('style', "background-color: white");
    });
    $(document).delegate('.comDbtn', 'click', function() {
        var l = $(this).parent().attr('label').split('~');
        console.log(l[0] + "***" + l[1]);
        $(this).parent().remove();
        var a = l[0],
            b = l[1];
        $('.hilite[name="' + a + '~' + b + '"]').removeClass('hiliteOn');
        $('.hilite[name="' + a + '~' + b + '"]').removeClass('hilite');
    });

    $(document).bind('mouseup', function() {
    if ($('#addCommentbtn').attr('style') != 'display: none;') {
        //console.log('mouseup');
        hideInlineCommentBtn();
    }
    $(document).unbind('mousemove');
    });

    elRTE.prototype.options.panels.essayEditorPanel = [
        'bold', 'italic', 'underline', 'forecolor', 'hilitecolor', 'justifyleft', 'justifyright',
        'justifycenter', 'justifyfull', 'formatblock', 'insertorderedlist', 'insertunorderedlist'
    ];
    elRTE.prototype.options.toolbars.essayEditorToolbar = ['essayEditorPanel'];
    elRTE.prototype.filter.prototype.chains = {};
    opts = {
        doctype: '<!DOCTYPE HTML>',
        cssClass: 'el-rte essayCont',
        absoluteURLs: true,
        allowSource: false,
        styleWithCSS: true,
        fmAllow: false,
        allowPaste: false,
        toolbar: 'essayEditorToolbar',
        cssfiles: ['elrte-1.3/css/elrte-inner.css']
    };
  
});
function gradedEssayCallback(data, extraParams)
{
    try{
        viewEssayForFeedback(data);
    }
    catch(er){
         $('.modal').html('<div class="centerCenter">You have not attempted this section.</div>');
    }
}

function evaluateEssayCallback(data, extraParams)
{
    var mode = extraParams[0];
    try{
        viewEssayForEvaluation(data,mode);
    }
    catch(er){
         //$('.modal').html('<div class="centerCenter">You have not attempted this section.</div>');
           $('.modal').html(er.message); 
    }
}

function getUrlParameters(){
    var query = document.URL.split('?')[1];
    params = query.split('&');
    parameters = {};
    for(var i = 0; i < params.length; i++){
        var param = params[i].split('=');
        parameters[param[0]] = param[1];
    }
}

function updateLists() {
    window.parent.showTeacherAllotedEssaysPage();
    window.parent.showTeacherAllotmentViewPage();
}

function saveFeedback(stat) {
    var midSave = false;
    if (stat == -1) {
        midSave = true;
        stat = 0;
    }
    else {
        if ($("#essayScore").val().trim() == "") {
            window.parent.alert('You cannot leave the score blank.');
            $("#essayScore").focus();
            return;
        } else if (isNaN($("#essayScore").val().trim())) {
            window.parent.alert('Score has to be numeric. Please add a valid score.');
            $("#essayScore").focus();
            return;
        } else if ($("#essayScore").val().trim() * 1 > 10 || $("#essayScore").val().trim() * 1 < 0) {
            window.parent.alert('Score has to be between 0 and 10. Please add a valid score.');
            $("#essayScore").focus();
            return;
        }
        if (stat==1 && $("#essayScore").val().trim() * 1 == 0) {
            window.parent.alert('You seem to have not graded this essay. Score has to be greater than 0.');
            $("#essayScore").focus();
            return;
        }
    }
    if (stat == 1) {
        var c = confirm('Are you sure you want to submit the feedback and score? You will not be able to edit it once you submit it.');
        if (!c) return;
    } else if (stat == 1.5) {
        stat = 1;
    }
    if (!midSave) {
        essayOpen = false;
        console.log('midSave'+midSave);
        $('#saveFB').attr("disabled", "disabled");
        $('#submitFB').attr("disabled", "disabled");
        $('#closeM').attr("disabled", "disabled");
    }
    var sfbChildren = $('#essaySpecificFB').children();
    var sfbMaster = "";
    for (var i = 0; i < sfbChildren.length; i++) {
        var y = sfbChildren[i];
        if (i > 0) sfbMaster += '{|~|}';
        if (y.getElementsByClassName('comT').length == 0)
            sfbMaster += addslashes(stripslashes(y.title)) + '|*|' + addslashes(y.getAttribute('label')) + '|*|' + addslashes(y.getElementsByClassName('comM')[0].innerHTML);
        else
            sfbMaster += addslashes(stripslashes(y.title)) + '|*|' + addslashes(y.getAttribute('label')) + '|*|' + addslashes(y.getElementsByClassName('comT')[0].value);
    }

    var scID = $('#scoreID').val();
    var eScore = $("#essayScore").val().trim()*1;
    //console.log(new Object({scoreID : scID, status: stat, essayFeedback: $("#essayReport").html(), essayScore: eScore, essaySFB : sfbMaster}));
    var request = $.ajax({
        url: "../../../../../essaywriting/controller.php",
        type: "POST",
        data: {
            scoreID: scID,
            status: stat,
            essayFeedback: $("#essayReport").html(),
            essaySFB: sfbMaster,
            essayScore: eScore,
            rubricSc: rubricVals.join(','),
            userType: 2,
            userStatus: 1,
            application: 1
        },
        dataType: 'json'
    });
    request.done(function(msg) {
        console.log(msg);
        if (midSave) return;
        if (msg.val == "success") {
            hideModal();
            essayOpen = false;
            if (stat == 1) {
                if ($('#userType').val() == "2") {
                    if (parseInt($('#userStatus').val()) == 4) $('#userStatus').val(5);
                    else if (parseInt($('#userStatus').val()) == 3) $('#userStatus').val(4);
                    //changeStatus();
                    
                }
            }
        } else {
            essayOpen = true;
            $('#savecloseM').removeAttr("disabled");
            $('#submitEssay').removeAttr("disabled");
            $('#closeM').removeAttr("disabled");
        }
        
    });
    request.fail(function(jqXHR, textStatus) {
        //alert( "Request failed: " + textStatus );
        essayOpen = true;
        $('#savecloseM').removeAttr("disabled");
        $('#submitEssay').removeAttr("disabled");
        $('#closeM').removeAttr("disabled");
    });
    
    if(!midSave)
        updateLists();
}

function saveEssay(stat) {
    /*if ($("#essayTitle").val().trim()==""){
alert('You cannot leave the title blank.');
$("#essayTitle").focus();
return;
}*/

    
    if (stat == 1) {
        var c = confirm('Are you sure you want to submit the essay? You will not be able to edit it once you submit it.');
        if (!c) return;
    } else if (stat == 1.5) {
        stat = 1;
    }  
    
    $("#checkWordLength").html($("#essayBody").elrte('val'));
    $("#essayBody").html($("#essayBody").elrte('val'));
   //var checkWordLength=$("#essayBody").elrte('val');
   
    if (stat==1){
         
        var words = $("#checkWordLength").text().trim().replace(/\s+/gi, ' ').split(' ').length;
        var chars = $("#checkWordLength").text().length;
        if (chars === 0) {
            words = 0;
        }
        
        
        if (words<10){
            alert('Your essay is too short! Please complete your essay.');
            return;
        }
    }
    
    essayOpen = false;
    $('#saveEssay').attr("disabled", "disabled");
    $('#submitEssay').attr("disabled", "disabled");
    $('#closeM').attr("disabled", "disabled");
    $("#essayBody").attr('contentEditable', 'false');
    $('.overlay').css({
        'display': 'block'
    });

    var eID = $('#essID').val();
    
    var request = $.ajax({
        url: "../../../../../essaywriting/controller.php",
        type: "POST",
        data: {
            essayID: eID,
            status: stat,
            essayBody: $("#essayBody").html(),
            essayTitle: $("#essayTitle").text(),
            essayTime: $("#timeTaken").attr('label')
        },
        dataType: 'json'
    });
    request.done(function(msg) {
       
        if (!msg) {
            hideModal();
            essayOpen = false;
        }
        if (msg.val == "success") {
            hideModal();
            essayOpen = false;
            if (stat == 1) {
                if ($('#userStatus').val() == "2" && $('#userType').val() == "2") {
                    $('#userStatus').val(3);
                    //changeStatus();

                    
                }
            }
        } else {
            essayOpen = true;
            startEssayTimer();
            $('#saveEssay').removeAttr("disabled");
            $('#submitEssay').removeAttr("disabled");
            $('#closeM').removeAttr("disabled");
        }
    });
    request.fail(function(jqXHR, textStatus) {
        //alert( "Request failed: " + textStatus );
        essayOpen = true;
        startEssayTimer();
        $('#saveEssay').removeAttr("disabled");
        $('#submitEssay').removeAttr("disabled");
        $('#closeM').removeAttr("disabled");
    });
}

function moveCommentBtn(e) {
    $('#addCommentbtn').css({
        top: (e.pageY + 10) + 'px',
        left: (e.pageX + 10) + 'px'
    });
}
var el, userInput, sel, range, selEndOffset, selStartOffset;

function setCursor() {
    el = document.getElementById('essayBody');
    range = rangy.createRange();
    range.selectNodeContents(el);
    range.selectCharacters(el, selStartOffset, selEndOffset);
    sel = rangy.getSelection();
    sel.setSingleRange(range);
}

function setHiliteN(n, evalNum , isSpellErrorComment) {
    //console.log('set HiliteN');
    setCursor();
    var commentText="";
    var sSel = selStartOffset;
    var eSel = selEndOffset;
    rSel = rangy.getSelection(); //console.log(rSel);
    var txt = rSel.toHtml().replace(/style="background-color:#ff0000"/g, 'class="hilite" name="' + sSel + '~' + eSel + '"');
    var textK = rSel.text();
    //console.log(rSel.toHtml()+'------'+txt+'--------'+textK);
    rRange = rSel.getRangeAt(0);
    rRange.deleteContents();
    var node = rRange.createContextualFragment('<span class="hilite ' + evalNum + '" name="' + sSel + '~' + eSel + '">' + txt + '</span>');
    rRange.insertNode(node);
    
    if (n == 1) {
        var sDiv = document.getElementById('essaySpecificFB');
        //var comm=prompt("Please enter your comment:","Comment for selected text ('"+rSel.text()+"').");
        sDiv.innerHTML += '<div class="comment" title="Comment for [' + textK.replace(/\"/g, '\\"') + ']" label="' + sSel + '~' + eSel + '" ><div class="comM" contentEditable="false" style="background-color: white;"><textarea class="comT"></textarea></div><div class="comSbtn"></div><div class="comEbtn" style="display:none;"></div><div class="comDbtn"></div></div>';
    }else if(isSpellErrorComment)
    {
        var sDiv = document.getElementById('essaySpecificFB');
        //var comm=prompt("Please enter your comment:","Comment for selected text ('"+rSel.text()+"').");
        if(window.essaySpellingErrors.length > 0)
        {
            for(var i=0;i<window.essaySpellingErrors.length;i++)
            {   
                //debugger;
                el = document.getElementById('essayBody');
                var essayText = el.textContent || el.innerText;
                var regex = new RegExp('\\b' + window.essaySpellingErrors[i] + '\\b');
                var sSel = essayText.search(regex);
                var eSel = sSel+window.essaySpellingErrors[i].length;
                sDiv.innerHTML += '<div class="comment" title="Comment for [' + window.essaySpellingErrors[i].replace(/\"/g, '\\"') + ']" label="' + sSel + '~' + eSel + '" ><div class="comM" contentEditable="false" style="background-color: white;"><textarea class="comT">Misspelt: '+window.essaySpellingErrors[i]+'</textarea></div><div class="comSbtn"></div><div class="comEbtn" style="display:none;"></div><div class="comDbtn"></div></div>';
            }    
        }    
        
    }   
    rSel.removeAllRanges();
    return;
}

function getCursor() {
    //console.log('get Cursor');
    el = document.getElementById('essayBody');
    userInput = el.textContent || el.innerText;
    sel = rangy.getSelection();
    range = sel.getRangeAt(0);
    
    // Get the text preceding the selection boundaries and then remove whitespace to get the character offsets
    var rangePrecedingBoundary = range.cloneRange();
    rangePrecedingBoundary.setStart(el, 0);
    selEndOffset = rangePrecedingBoundary.text().length;
    rangePrecedingBoundary.setEnd(range.startContainer, range.startOffset);
    selStartOffset = rangePrecedingBoundary.text().length;
    rangePrecedingBoundary.detach();
}

function showInlineCommentBtn() {

    $('#addCommentbtn').show();
    $(document).bind('mousemove', function(event) {
        moveCommentBtn(event);
    });
}

function hideInlineCommentBtn() {
    try {
        var rangek = rangy.getSelection().getRangeAt(0);
        if (rangek.text().length == 0) {
            $('#addCommentbtn').hide();
            $(document).unbind('mousemove');
        }
    } catch (err) {
        $('#addCommentbtn').hide();
        $(document).unbind('mousemove');
    }
}

function setWordCount(n) {
    var ek = $('#essayBody')[0];
    if (n == 1) ek = $('.essayCont>.workzone>iframe')[0].contentWindow.document.body;
    var textcontent = ek.textContent;
    var words = textcontent.trim().replace(/\s+/gi, ' ').split(' ').length;
    var chars = textcontent.length;
    if (chars === 0) {
        words = 0;
    }
    $('#wordCount').html(words + ' words');
}

function showModal() {
    $(".modal").show();
}

function hideModal() {
    essayOpen = false;
    clearTimeout(timeOutVar);
    updateLists();
	$(".modal").html('');
    $(".modal").hide();
}

function viewEssayForFeedback(msg){
    if (msg.error) {
        if (msg.error == 3) window.parent.alert(msg.message);
        hideModal();
        return;
    }
    
    essayOpen = true;
    eTitle = '<span id="essayTitle">' + msg.title + '</span>'; //eTitle="";
    modTitle = "View Essay and Feedback";
    submitOn = 'Submitted On: ' + msg.submittedOn;
    
    $('.modal').html('<table width="100%" style="border-spacing:0px;"><tr height="20px"><th>' + modTitle + ' (Essay ID: ' + msg.essayID + ')<span class="floatRight">Time taken: <span id="timeTaken" label="' + msg.timeTaken + '">' + Math.floor(msg.timeTaken / 60) + ':' + msg.timeTaken % 60 + '</span></span></th></tr><tr height="20px"><td style="padding-left:10px; padding:right:10px;text-align:left;"><input type="hidden" id="essID" value=' + msg.essayID + ' />Title: ' + eTitle + '</td></tr><tr><td id="essayBodTD"></td></tr></table>');
    
    $('#timeTaken').parent().hide();
    var fbs = msg.report;
    var totalScore = 0;
    var l;
    if(fbs)
        l = Object.keys(fbs).length;
    var fbRs = "";
    msg.essay=msg.essay.replace(/&nbsp;/ig,' ');
	msg.essay=msg.essay.replace(/<p[^>]*?>/g,'');
	msg.essay=msg.essay.replace(/<\/p>/ig,'<br />');
    msg.essay=msg.essay.replace(/<p><\/p>/ig,'<br/>');
    msg.essay=msg.essay.replace(/\<br \/>/ig,'<br /> ');
    msg.essay=msg.essay.replace(/\<li>/ig,'<li> ');
	msg.essay=msg.essay.replace(/(<p[^>]+?>|<p>|<\/p>)/ig,''); 
    $('#essayBodTD').html('<div id="essayBody">' + msg.essay + '</div><div id="essayReport"></div>');
    el = document.getElementById('essayBody');
    //sel = rangy.getSelection();
    //range = sel.getRangeAt(0);
    for (var i = 0; i < l; i++) {
        var fb = eval("fbs.f" + (i + 1));
        var sfbckT = "";
        if (fb.selectFeedback != "") {
            var sfbck = fb.selectFeedback.split('{|~|}');
            for (var g = 0; g < sfbck.length; g++) {
                var sfbi = sfbck[g].split('|*|');
                if ((sfbi).length != 3) continue;
                sfbckT += '<div class="comment" title="' + sfbi[0] + '" label="' + sfbi[1] + '" ><div class="comM" contentEditable="false" style=width:280px;"">' + stripslashes(sfbi[2]) + '</div></div>';
              
                var indicesMultiple      = sfbi[1].split('-');
                var newArray =  indicesMultiple.filter(function(v){return v!==''});
                
                for (var k = 0; k < newArray.length; k++) 
                {
                    var indicesSting     = newArray[k].split('~');
                    var selStartOffset   = indicesSting[0]*1;
                    var selEndOffset     = indicesSting[1].replace(/\D+/g, '') * 1;  // Removed all special character from the end index like "-"  
                    selectAndHighlightRange(el,selStartOffset,selEndOffset);
                }

                /*var lab = sfbi[1].split('~');
                selStartOffset = lab[0] * 1;*/
                //selEndOffset = lab[1] * 1;
                //selEndOffset = lab[1].replace(/\D+/g, '') * 1;   // Removed all special character from the end index like "-"  
                //setCursor();
                //setHiliteN(0, 'eFB' + i);
                //selectAndHighlightRange(el,selStartOffset,selEndOffset);
            }
        }
        var fbm = stripslashes(fb.feedback) + "<br><br>" + sfbckT + "<br>"; //<br><i>Dated:"+fb.submittedOn+"</i>";
        fbRs += '<h3>Score: ' + fb.score + '</h3><div>' + fbm + '</div>';
        totalScore += fb.score * 1;
        $('.eFB' + i).addClass('nohilite');
    }
    $('#essayBodTD').html('<div id="essayBody">' + $('#essayBody').html() + '</div><div id="essayReport"></div>');
    var avgScore = "-";
    if (l > 0) avgScore = totalScore / l;
    
	$('#essayReport').html('<table width="100%" height="100%" cellspacing="0"><tr><th style="height:25px;text-align:center;">Overall Feedback</th></tr><tr><td style="vertical-align:top;"><div class="accordion">' + fbRs + '</div></td></tr></table>');
   
   $('.accordion > div').hide();
   $('.accordion > h3').bind('click', function(){
       $(this).next('div').toggle();
       if(!$(this).next('div').is(':visible') && (this != $('.accordion > h3:last-child')[0])){
           $('.accordion > h3:last-child').trigger('click');
           return;
       }
       var active = 3333;
       var h3s = $('.accordion > h3');
       for(var i = 0 ; i < h3s.length; i++){
           if(this == h3s[i]){
               active = i;                                     
           }
           else{
               $(h3s[i]).next('div').hide();
           }
       }
       
       $('.hilite').removeClass('nohilite');
       $('.hilite').addClass('nohilite');
       $('.eFB' + active).removeClass('nohilite');
   });
   if(fbs){
	   if(l == 1)  
			$(".accordion > h3").trigger( "click" );
	}
       
   anyFB = msg.anyfb;
}

 function getTextNodesIn(node) {
    var textNodes = [];
    if (node.nodeType == 3) {
        textNodes.push(node);
    } else {
        var children = node.childNodes;
        for (var i = 0, len = children.length; i < len; ++i) {
            textNodes.push.apply(textNodes, getTextNodesIn(children[i]));
        }
    }
    return textNodes;
}

function setSelectionRange(el, start, end) {
    if (document.createRange && window.getSelection) {
        
        var range = document.createRange();
        range.selectNodeContents(el);

        var textNodes = getTextNodesIn(el);
        var foundStart = false;
        var charCount = 0, endCharCount;
        //start = adjustOffset(el, start);
        //end = adjustOffset(el, end);
        for (var i = 0, textNode; textNode = textNodes[i++]; ) {
            endCharCount = charCount + textNode.length;
            if (!foundStart && start >= charCount && (start < endCharCount || (start == endCharCount && i <= textNodes.length))) {
                range.setStart(textNode, start - charCount);
                foundStart = true;
            }
            if (foundStart && end <= endCharCount) {
                range.setEnd(textNode, end - charCount);
                break;
            }
            charCount = endCharCount;
            
        }
        //var range = dig(el,start,end);
        var sel = window.getSelection();
        sel.removeAllRanges();
        sel.addRange(range);
        
    } else if (document.selection && document.body.createTextRange) {
        var textRange = document.body.createTextRange();
        textRange.moveToElementText(el);
        textRange.collapse(true);
        textRange.moveEnd("character", end);
        textRange.moveStart("character", start);
        textRange.select();
    }
}

function makeEditableAndHighlight(colour,selStartOffset,selEndOffset) {
    
    var content,span,sel;
    sel = window.getSelection();
    if (sel.rangeCount && sel.getRangeAt) {
        range = sel.getRangeAt(0);
    }
    if (range) {
        sel.removeAllRanges();
        sel.addRange(range);
    }
    // Use HiliteColor since some browsers apply BackColor to the whole block
    //document.designMode = "on";
    /*if (!document.execCommand("HiliteColor", false, colour)) {
        document.execCommand("backColor", false, colour);
    }
*/
    if(typeof window.getSelection().anchorNode.parentElement != 'undefined')
        var cloneContent = window.getSelection().focusNode.parentElement;
    else
        var cloneContent = window.getSelection().focusNode.parentNode; 
    var range = window.getSelection().getRangeAt(0);
    var regex = new RegExp('\\b' + range.toString());
    var commonAncestorContainer=range.commonAncestorContainer.toString();
    
    
    if(cloneContent.outerHTML.search(regex) == -1 && commonAncestorContainer != '[object HTMLULElement]'){
        highlightTagStrings(selStartOffset,selEndOffset);
        sel.removeAllRanges();
        return; 
    }
    
    if(commonAncestorContainer != '[object Text]' && commonAncestorContainer != '[object HTMLParagraphElement]' && commonAncestorContainer != '[object HTMLElement]')
    {
        
        span = document.createElement('SPAN');
        span.className='startIndex-'+selStartOffset+' endIndex-'+selEndOffset+'';
        span.style.background = 'pink';
        span.innerHTML = range.toString();
        //cloneContent.outerHTML.replace(range.toString(),span.outerHTML);
        $(cloneContent).replaceWith(cloneContent.outerHTML.replace(range.toString(),span.outerHTML));
        sel.removeAllRanges();
        return;
    }
    
    
    content = range.extractContents();
    span = document.createElement('SPAN');
    span.className='startIndex-'+selStartOffset+' endIndex-'+selEndOffset+'';
    span.style.background = 'pink';
    span.appendChild(content);
    var htmlContent = span.innerHTML;
    range.insertNode(span);

    /*if(window.getSelection().focusNode.parentNode.style.backgroundColor == 'pink')
    {
        var parent_node = getOutterMostParent(window.getSelection().focusNode);
         $(listId).addClass('startIndex-'+ parseInt(startIndex) +' endIndex-'+parseInt(endIndex));
    }   
    document.designMode = "off";*/
    sel.removeAllRanges();
    //range.detach();

}

function highlight(colour,start,end) {
    var range, sel;
    if (window.getSelection) {
        // IE9 and non-IE
        try {
            //if (!document.execCommand("backColor", false, colour)) {
                makeEditableAndHighlight(colour,start,end);
            //}
        } catch (ex) {
            makeEditableAndHighlight(colour,start,end)
        }
    } else if (document.selection && document.selection.createRange) {
        // IE <= 8 case
        range = document.selection.createRange();
        range.execCommand("backColor", false, colour);
    }
}

function selectAndHighlightRange(id, start, end) {
    setSelectionRange(id, start, end);
    highlight("pink",start,end);
}

function highlightTagStrings(selStartOffset,selEndOffset) {
        var selection,selectedRange;
        selection = rangy.getSelection(); //console.log(rSel);
        var txt = selection.toHtml();
        selectedRange = selection.getRangeAt(0);
        selectedRange.deleteContents();
        //var node = selectedRange.createContextualFragment('<span class="hilite ' + evalNum + '" name="' + sSel + '~' + eSel + '">' + txt + '</span>');
        var node = selectedRange.createContextualFragment('<span style="background-color:pink" class="startIndex-' + selStartOffset + ' endIndex-' + selEndOffset + '">' + txt + '</span>');
        selectedRange.insertNode(node);
        selection.removeAllRanges();
        return;
    }


function viewEssayForEvaluation(msg,mode){
        var msg = msg.data;
        var mode = parseInt(mode);
        if (msg.error) {
            if (msg.error == 3) window.parent.alert(msg.message);
            hideModal();
            return;
        }
           
        essayOpen = true;
        var fbs = msg.report;
        if(msg.essaySpellingErrors!=undefined)
            window.essaySpellingErrors=msg.essaySpellingErrors;
        var editable = true,
            modTitle = "",
            submitOn = "",
            sfbBtns = "",
            showSelBtn = '',
            commo = '',
            ttkn = '',
            rubricSh = '';
        switch (mode) {
            case 0:
                editable = 'contentEditable="true"';
                modTitle = "Add/Edit Feedback";
                submitOn = "&nbsp;&nbsp;|&nbsp;&nbsp;Alloted on: " + dateTimeFormat(fbs.allotedOn);
                sfbBtns = '<div class="comSbtn" style="display:none;"></div><div class="comEbtn"></div><div class="comDbtn"></div></div>';
                showSelBtn = ' onselectstart="showInlineCommentBtn();"';
                rubricSh = rubricHTML;
                break;
            case 1:
                editable = '';
                modTitle = "View Feedback";
                submitOn = "&nbsp;&nbsp;|&nbsp;Reviewed on: " + dateTimeFormat(fbs.submittedOn);
                commo = ' comMO';
                break;
        }
        
        if ($('#userStatus').val() == "1") ttkn = '|&nbsp;Time taken: <span id="timeTaken" label="' + msg.timeTaken + '">' + Math.floor(msg.timeTaken / 60) + ':' + msg.timeTaken % 60 + '</span>';
        else ttkn = '';

        $('.modal').html('<table width="100%" height="100%"><tr height="20px"><th>' + modTitle + ' (Essay ID: ' + msg.essayID + ') &nbsp;&nbsp;&nbsp;| Student class: ' + msg.writerClass + '</th></tr><tr height="25px"><td><input type="hidden" id="scoreID" value="' + fbs.scoreID + '"/>Title: ' + msg.title + '&nbsp;&nbsp;|&nbsp;Essay submitted: ' + dateTimeFormat(msg.submittedOn) + '&nbsp;&nbsp;' + ttkn + submitOn + ' &nbsp;&nbsp;|&nbsp;&nbsp;<span id="wordCount"></span></td></tr><tr><td id="essayBodTD"></td></tr><tr height="30px"><td id="mfooter"></td></tr></table>');
        $('#essayBodTD').html('<div id="essayBody" style="width:420px;"' + showSelBtn + '>' + msg.essay + '</div><div id="essaySpecificFB" style="width:420px;"></div><div id="essayReport" style="width:420px;" ' + editable + '>' + fbs.feedback + '</div>');
        setCursor();
        el = document.getElementById('essayBody');
        sel = rangy.getSelection();
        range = sel.getRangeAt(0);
        if (fbs.selectFeedback != "") {
            var sfbck = fbs.selectFeedback.split('{|~|}');
            var sDiv = document.getElementById('essaySpecificFB');
            for (var i = 0; i < sfbck.length; i++) {
                var sfbi = sfbck[i].split('|*|');
                if ((sfbi).length != 3) continue;
                //console.log(sfbi[0]+'  '+sfbi[1]+'  '+sfbi[2]);
                sDiv.innerHTML += '<div class="comment" title="' + stripslashes(sfbi[0]).replace(/\"/g, '\\"') + '" label="' + sfbi[1] + '" ><div class="comM' + commo + '" contentEditable="false" style="">' + stripslashes(sfbi[2]) + '</div>' + sfbBtns;
                var lab = sfbi[1].split('~');
                selStartOffset = lab[0] * 1;
                selEndOffset = lab[1] * 1;
                setHiliteN(0, '',0);
            }
        }else{
            setHiliteN(0, '',1);        
        }
        $('#essayBodTD').html('<div id="essayBody" style="width:420px;"' + showSelBtn + '>' + $('#essayBody').html() + '</div><div id="sfb"></div><div id="essaySpecificFB" style="width:420px;">' + $('#essaySpecificFB').html() + '</div><div class="dragbar" style="width:432px;"></div><div id="ofb"></div><div id="essayReport" style="width:420px;" ' + editable + '>' + stripslashes(fbs.feedback) + '</div><div id="rubricBox">' + rubricSh + '</div>');
        $(document).mouseup(function(e) {
            $(document).unbind('mousemove');
        });
        setRubric([-1, -1, -1, -1, -1, -1, -1]);
        if (fbs.rubricSc) {
            if (fbs.rubricSc.split(',').length == 7) setRubric(fbs.rubricSc.split(','));
        }
        if (mode == 0) {
            $('#mfooter').html('<div style="background-color:#cb9ce7;float:left;border-radius:5px;">&nbsp;&nbsp;&nbsp; Score: <input type="text" value="' + fbs.score + '" id="essayScore" pattern="[0-9]*" size="3" style="text-align:right;border-radius:3px;"/> on 10&nbsp;&nbsp;&nbsp; </div>&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; <input type="button" onclick="saveFeedback(0);" id="saveFB" value="Save Feedback"/><input type="button" value="Submit Feedback" onclick="saveFeedback(1);" id="submitFB"/><input type="button" value="Close" onclick="hideModal();" id="closeM"/>');
        } else
            $('#mfooter').html('Score: ' + fbs.score + ' &nbsp;&nbsp;&nbsp;<input type="button" value="Close" onclick="hideModal();" id="closeM"/>');
        setWordCount(0);
        //var bdH=$('#essayBody').height()-6-52;
        //$('#essayReport').css("height",$('#essayReport').height()-8);
        //$('#essaySpecificFB').css('height',bdH/2);
        //$('#essayReport').css('height',bdH-$('#essaySpecificFB').height());
        //$('#rubricBox').css('height',$('#essayBody').height()+20);
        $('.dragbar').mousedown(function(e) {
            e.preventDefault();
            var totHeight = $('#essayBody').height() - 6 - 52;
            $(document).mousemove(function(e) {
                e.preventDefault();
                var mPos = {
                    X: e.pageX - $('#essaySpecificFB').offset().left,
                    Y: e.pageY - $('#essaySpecificFB').offset().top
                };
                var nht = mPos.Y - 6;
                if (nht / totHeight > 0.25 && nht / totHeight < 0.75) {
                    //$('#essayReport').css("height", totHeight - nht);
                    //$('#essaySpecificFB').css("height", nht);
                }
            });
        });
        //$("#rubricBox" ).toggle("slide");
        resizeElems();

        /*$('.accordion > div').hide();
       $('.accordion > h3').bind('click', function(){
           $(this).next('div').toggle();
           if(!$(this).next('div').is(':visible') && (this != $('.accordion > h3:last-child')[0])){
               $('.accordion > h3:last-child').trigger('click');
               return;
           }
           var active = 3333;
           var h3s = $('.accordion > h3');
           for(var i = 0 ; i < h3s.length; i++){
               if(this == h3s[i]){
                   active = i;                                     
               }
               else{
                   $(h3s[i]).next('div').hide();
               }
           }
           
           $('.hilite').removeClass('nohilite');
           $('.hilite').addClass('nohilite');
           $('.eFB' + active).removeClass('nohilite');
       });
       if(fbs){
           if(l == 1)  
                $(".accordion > h3").trigger( "click" );
        }
           
       anyFB = msg.anyfb;*/

}

function setRubric(rubricArr) {
    $(rubricArr).each(function(index) {
        rubricVals[index] = rubricArr[index] * 1
    });
    for (var i = 0; i < 7; i++) {
        if (rubricVals[i] >= 0) $("#r" + (i + 1) + rubricVals[i]).attr("checked", "true");
    }
}

function resizeElems() {
    $('#contentRow').css('height', '100%');
    var s = 3;
    $('#contentRow').siblings().each(function() {
        s += $(this).outerHeight();
    });
    $('#contentRow').css('height', $(document).height() - s);

    var s = 4;
    $('#essayBodTD').parent().siblings().each(function() {
        s += $(this).outerHeight() + 2;
    });
    //$('#essayBodTD').css('height', $('#contentRow').height() - s);
    $('#essayBody').css('height', '100%');

    var bdH = $('#essayBody').height() - $('.dragbar').height() - $('#ofb').height() - $('#sfb').height();
    /*$('#essayReport').css("height",$('#essayReport').height()-8);
    $('#essaySpecificFB').css('height', bdH / 2);*/
    $('#essayReport').css('height', bdH - $('#essaySpecificFB').height());
    $('#essayReport').css("height",'170px');
    $('#essaySpecificFB').css('height','170px');
    $('#rubricBox').css('height', $('#essayBody').outerHeight());
}


function addslashes(str) {
    str = str.replace(/\\/g, '\\\\');
    str = str.replace(/\'/g, '\\\'');
    str = str.replace(/\"/g, '\\"');
    str = str.replace(/\0/g, '\\0');
    return str;
}

function stripslashes(str) {
    str = str.replace(/\\'/g, '\'');
    str = str.replace(/\\"/g, '"');
    str = str.replace(/\\0/g, '\0');
    str = str.replace(/\\\\/g, '\\');
    return str;
}

function dateTimeFormat(str) {
    return str.replace(/(\d{4})-(\d{2})-(\d{2}) (\d{2}):(\d{2}):\d{2}/g, '$3/$2/$1 $4:$5');
}